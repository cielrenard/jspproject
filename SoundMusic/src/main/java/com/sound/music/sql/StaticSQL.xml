<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
				"-//mybatis.org//DTD Mapper 3.0//EN" 
				"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="static">
	<sql id="isShow">
		UPPER(s_IsShow)='Y'
	</sql>
	<sql id="selectField">
		 s_Title AS TITLE, s_Date AS WDAY, s_Hit AS HIT, s_Song AS song, s_Artist AS artist
	</sql>
	<sql id="selectFileInfo">
		sf_OriName AS oriName, sf_SaveName AS saveName, sf_FilePath AS path
	</sql>
	<!-- 게시물 개수 구하기 -->
	<select id="totalCount" resultType="int">
		select count(*) as cnt from StaticMusic where upper(s_IsShow)='Y'
	</select>
	<!-- 게시물 등록 -->
	<insert id="insertStatic" parameterType="Static">
		<selectKey order="BEFORE" resultType="int"  keyProperty="no">
			select NVL(max(s_No),0)+1 from StaticMusic where s_IsShow='Y'
		</selectKey>
		insert into StaticMusic values(#{no}, #{title}, #{body}, 'Y', 0, SYSDATE,#{artist},#{song})
	</insert>
	<!-- 업로드된 파일 정보 등록-->
	<insert id="insertFile" parameterType="Static">
		<selectKey order="BEFORE" resultType="int"  keyProperty="no">
			select NVL(max(sf_No),0)+1 from StaticFile
		</selectKey>
		insert into StaticFile values(#{no}, #{oriNo},#{path},#{oriName},#{saveName},#{len},0)
	</insert>
	<!-- 게시물 목록보기 -->
	<select id="selectList" resultType="Static" parameterType="Static">
		SELECT * FROM 
		 (SELECT StaticMusic.s_No AS NO, <include refid="selectField"/>, 
	 	 ROW_NUMBER() OVER(ORDER BY StaticMusic.s_NO ASC) AS RNO, 
		 NVL(t1.CNT, 0) AS FILECOUNT FROM StaticMusic, 
		(SELECT COUNT(*) AS CNT, s_No as no FROM staticFile GROUP BY s_No) t1
		 WHERE <include refid="isShow"/> AND 
		 StaticMusic.s_No = t1.no(+)) 
		WHERE RNO BETWEEN #{start} AND #{end}
	</select>
	<!-- 조회수 증가 질의 명령 -->
	<update id="updateHit" parameterType="int">
		update staticMusic set s_Hit=s_Hit+1 where s_No=#{no}
	</update>
	<resultMap id="clobDetail" type="static">
		<result property="body" column="s_Body" jdbcType="CLOB" javaType="java.lang.String"/>
	</resultMap>
	<!-- 상세보기 질의 명령 -->
	<select id="selectDetail" resultMap="clobDetail" parameterType="int">
		select s_No as no, s_body, <include refid="selectField"/> from StaticMusic
		where s_No=#{no}
	</select>
	<!-- 첨부파일 검색 질의 -->
	<select id="fileInfo" parameterType="int" resultType="static">
		select sf_No as no, s_No as oriNo, <include refid="selectFileInfo"/>, sf_Length as len
		from staticFile where s_No=#{oriNo}
	</select>
	<!-- 댓글등록 질의 -->
	<insert id="insertReply" parameterType="static">
		<selectKey order="BEFORE" resultType="int"  keyProperty="no">
			select NVL(max(sr_No),0)+1 from StaticReply where sr_IsShow='Y'
		</selectKey>
		insert into StaticReply values (#{no},#{oriNo},#{mId},#{body},#{pw}, sysdate,'Y')
	</insert>
	<!-- 댓글수정 질의 -->
	<update id="updateReply" parameterType="static">
		update StaticReply set sr_Body=#{body}, sr_Pw=#{pw} where sr_No=#{no} and s_No=#{oriNo}
	</update>
	<!-- 댓글삭제 질의 -->
	<update id="deleteReply" parameterType="int">
		update StaticReply set sr_IsShow='N' where sr_No=#{no} and sr_Pw=#{pw}
	</update>
	<!-- 댓글 조회 질의 -->
	<select id="selectReply" parameterType="int" resultType="static">
		select sr_No as no, s_No as oriNo, m_Id as mId, sr_Body as body,
		sr_Pw as pw, sr_Date as wday from staticReply 
		where sr_IsShow='Y' and s_No=#{no}
	</select>
</mapper>